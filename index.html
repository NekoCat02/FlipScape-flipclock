<!DOCTYPE html>
<html>
<head>
  <title>FlipScape</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flipclock/0.7.8/flipclock.css">
  
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      transition: background-color 0.5s ease;
      overflow: hidden;
    }
    
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #2c2c2c;
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
    }

    #video-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }

    #video-background iframe {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100vw;
      height: 56.25vw; /* 16:9 aspect ratio */
      min-height: 100vh;
      min-width: 177.77vh; /* 16:9 aspect ratio for portrait screens */
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    #gradient-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      opacity: 0;
      pointer-events: none; 
      z-index: 1;
      transition: opacity 0.1s linear;
    }

    .clock-container {
      zoom: 2; 
      position: relative; 
      z-index: 2;
    }
    
    #date-container {
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
        margin-top: 20px;
        font-family: 'Roboto', sans-serif;
        font-size: 1.2rem;
        font-weight: 300;
        letter-spacing: 0.05em;
    }

    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      z-index: 100;
      padding: 10px; 
    }
    
    .top-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    #customizeBtn, #fullscreenBtn {
      width: 48px;
      height: 48px;
      padding: 8px;
      cursor: pointer;
      border: 2px solid #fff;
      background-color: rgba(0, 0, 0, 0.4);
      border-radius: 50%; 
      opacity: 0; 
      transition: opacity 0.3s ease-in-out; 
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    #customizeBtn.visible-on-load,
    #fullscreenBtn.visible-on-load {
        opacity: 1;
    }

    .controls:hover #customizeBtn,
    .controls:hover #fullscreenBtn {
        opacity: 1; 
    }
    
    #customizeBtn svg, #fullscreenBtn svg {
      width: 100%;
      height: 100%;
      transition: transform 0.3s ease-in-out; 
    }
    #customizeBtn svg line,
    #customizeBtn svg circle,
    #fullscreenBtn svg path {
        stroke: #ffffff;
        stroke-width: 8;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
    }
    
    #fullscreenBtn:hover .fullscreen-enter-icon {
        transform: scale(1.2);
    }

    #fullscreenBtn:hover .fullscreen-exit-icon {
        transform: scale(0.8);
    }
    
    #customizeBtn:hover svg {
        transform: scale(1.2);
    }

    #customizePanel {
      display: none;
      width: 240px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(5px);
      border-radius: 8px;
      display: flex;
      flex-direction: column; 
      gap: 15px;
      align-items: center;
    }

    .upload-controls {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    #colorPicker {
      width: 40px;
      height: 40px;
      border: none;
      cursor: pointer;
      background: none;
    }
    
    #imageUpload {
      display: none;
    }

    .upload-btn-label {
      padding: 8px 12px;
      font-family: sans-serif;
      font-size: 14px;
      color: #333;
      background-color: #fff;
      border-radius: 5px;
      cursor: pointer;
    }

    #size-control-container, #intensity-control-container, .font-control-group {
        width: 100%;
        text-align: center;
        color: white;
        font-family: sans-serif;
        font-size: 14px;
    }
    #sizeSlider, #intensitySlider, .font-control-group input[type="range"] {
        width: 100%;
        margin-top: 5px;
    }

    #formatToggleBtn {
        padding: 8px 15px;
        font-family: sans-serif;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid #aaa;
        background-color: #444;
        color: #fff;
        border-radius: 5px;
        width: 100%;
    }
    
    #resetBtn {
        padding: 8px 15px;
        font-family: sans-serif;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid #aaa;
        background-color: #444;
        color: #fff;
        border-radius: 5px;
        width: 100%;
    }

    .flip-clock-meridium a {
      color: #fff;
    }

    #gradient-presets-container {
        width: 100%;
        text-align: center;
        color: white;
        font-family: sans-serif;
        font-size: 14px;
    }
    #gradient-presets {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        justify-items: center;
        gap: 15px;
        margin-top: 8px;
        width: 100%;
    }
    .gradient-swatch {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.5);
        transition: transform 0.2s;
    }
    .gradient-swatch:hover {
        transform: scale(1.1);
    }
    
    .divider {
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        width: 100%;
    }

    /* --- NEW: Styles for the audio toggle switch --- */
    .audio-toggle-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        color: white;
        font-family: sans-serif;
        font-size: 14px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 28px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #4285F4;
    }
    input:checked + .slider:before {
      transform: translateX(22px);
    }
    /* --- End of styles --- */

  </style>
</head>
<body>

  <div id="video-background"><div id="youtube-player"></div></div>
  <div id="gradient-overlay"></div>

  <div class="clock-container">
    <div class="clock"></div>
    <div id="date-container"></div>
  </div>

  <div class="controls">
    <div class="top-buttons">
        <button id="fullscreenBtn" title="Toggle Fullscreen">
            <svg class="fullscreen-enter-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 40 L10 20 A 10 10 0 0 1 20 10 L40 10 M60 10 L80 10 A 10 10 0 0 1 90 20 L90 40 M90 60 L90 80 A 10 10 0 0 1 80 90 L60 90 M40 90 L20 90 A 10 10 0 0 1 10 80 L10 60"></path>
            </svg>
            <svg class="fullscreen-exit-icon" style="display: none;" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 30 L30 30 L30 10 M90 30 L70 30 L70 10 M10 70 L30 70 L30 90 M90 70 L70 70 L70 90"></path>
            </svg>
        </button>
        <button id="customizeBtn" title="Customize">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <line x1="10" y1="25" x2="90" y2="25"></line>
                <circle cx="35" cy="25" r="8"></circle>
                <line x1="10" y1="50" x2="90" y2="50"></line>
                <circle cx="65" cy="50" r="8"></circle>
                <line x1="10" y1="75" x2="90" y2="75"></line>
                <circle cx="35" cy="75" r="8"></circle>
            </svg>
        </button>
    </div>
    <div id="customizePanel">
        <div class="upload-controls">
            <input type="color" id="colorPicker" value="#2c2c2c" title="Choose background color">
            <label for="imageUpload" class="upload-btn-label">Custom bg</label>
            <input type="file" id="imageUpload" accept="image/*">
        </div>
        
        <div id="gradient-presets-container">
            <label>Gradients</label>
            <div id="gradient-presets">
                <div class="gradient-swatch" title="Sunset" data-gradient="linear-gradient(to right, #ff8177, #ff867a, #ff8c7f, #f99185, #cf556c, #b12a5b)" style="background: linear-gradient(to right, #ff8177, #ff867a, #ff8c7f, #f99185, #cf556c, #b12a5b);"></div>
                <div class="gradient-swatch" title="Ocean" data-gradient="linear-gradient(to right, #84fab0, #8fd3f4)" style="background: linear-gradient(to right, #84fab0, #8fd3f4);"></div>
                <div class="gradient-swatch" title="Plum" data-gradient="linear-gradient(to right, #a18cd1, #fbc2eb)" style="background: linear-gradient(to right, #a18cd1, #fbc2eb);"></div>
                <div class="gradient-swatch" title="Forest" data-gradient="linear-gradient(to right, #43e97b, #38f9d7)" style="background: linear-gradient(to right, #43e97b, #38f9d7);"></div>
                <div class="gradient-swatch" title="Nightfall" data-gradient="linear-gradient(to right, #2c3e50, #4ca1af)" style="background: linear-gradient(to right, #2c3e50, #4ca1af);"></div>
                <div class="gradient-swatch" title="Deep Space" data-gradient="linear-gradient(to right, #000000, #434343)" style="background: linear-gradient(to right, #000000, #434343);"></div>
                <div class="gradient-swatch" title="Grapevine" data-gradient="linear-gradient(to right, #333399, #ff00cc)" style="background: linear-gradient(to right, #333399, #ff00cc);"></div>
                <div class="gradient-swatch" title="Gunmetal" data-gradient="linear-gradient(to right, #606c88, #3f4c6b)" style="background: linear-gradient(to right, #606c88, #3f4c6b);"></div>
            </div>
        </div>
        
        <div class="divider"></div>
        <div id="youtube-control-container" style="width: 100%; text-align: center; color: white; font-family: sans-serif; font-size: 14px;">
            <label for="youtubeUrl" style="display: block; margin-bottom: 8px;">YouTube Background</label>
            <div style="display: flex; gap: 8px; width: 100%; align-items: center; margin-bottom: 10px;">
                <input type="text" id="youtubeUrl" placeholder="Paste YouTube URL" style="flex-grow: 1; box-sizing: border-box; padding: 8px; border-radius: 5px; border: 1px solid #aaa; background: #fff; color: #333; height: 35px;">
                <button id="applyYoutubeUrl" style="padding: 0 12px; font-family: sans-serif; font-size: 14px; cursor: pointer; border: 1px solid #aaa; background-color: #444; color: #fff; border-radius: 5px; height: 35px;">Apply</button>
            </div>
            <!-- --- Audio toggle switch --- -->
            <div class="audio-toggle-container">
              <label for="youtubeAudioToggle">Mute Audio</label>
              <label class="switch">
                <input type="checkbox" id="youtubeAudioToggle" checked>
                <span class="slider round"></span>
              </label>
            </div>
        </div>
        <div class="divider"></div>

        <div id="intensity-control-container">
            <label for="intensitySlider">Darken</label>
            <input type="range" id="intensitySlider" min="0" max="0.85" step="0.01" value="0">
        </div>
        
        <div id="size-control-container">
            <label for="sizeSlider">Clock Size</label>
            <input type="range" id="sizeSlider" min="0.5" max="4" step="0.1" value="2">
        </div>
        
        <div class="divider"></div>
        <div class="font-control-group">
            <label for="clockWeightSlider">Clock Font Weight</label>
            <input type="range" id="clockWeightSlider" min="100" max="900" step="10" value="400">
        </div>
        <div class="font-control-group">
            <label for="dateWeightSlider">Date Font Weight</label>
            <input type="range" id="dateWeightSlider" min="100" max="900" step="10" value="300">
        </div>
        <div class="divider"></div>

        <button id="formatToggleBtn">Switch to 12-Hour</button>
        <button id="resetBtn">Reset</button>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flipclock/0.7.8/flipclock.min.js"></script>
  <!-- ---  YouTube Iframe API Script --- -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      var clock;
      var is24HourFormat = true;
      var ytPlayer; // --- Variable to hold the YouTube player instance

      $('#customizePanel').hide();

      $('#customizeBtn, #fullscreenBtn').addClass('visible-on-load');
      setTimeout(function(){
          $('#customizeBtn, #fullscreenBtn').removeClass('visible-on-load');
      }, 3000);
      
      function getYouTubeID(url) {
        let ID = '';
        url = url.replace(/(>|<)/gi, '').split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/);
        if (url[2] !== undefined) {
          ID = url[2].split(/[^0-9a-z_\-]/i);
          ID = ID[0];
        } else {
          ID = url;
        }
        return ID;
      }
      
      // --- MODIFIED: This function uses the YouTube IFrame API ---
      function applyYoutubeBackground(url) {
        const videoId = getYouTubeID(url);
        if (videoId) {
          if (ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
            ytPlayer.loadVideoById(videoId);
          } else {

            ytPlayer = new YT.Player('youtube-player', {
              videoId: videoId,
              playerVars: {
                autoplay: 1,
                loop: 1,
                playlist: videoId, // Required for loop to work
                controls: 0,
                showinfo: 0,
                autohide: 1,
                modestbranding: 1,
                iv_load_policy: 3,
                disablekb: 1,
                enablejsapi: 1
              },
              events: {
                'onReady': onPlayerReady
              }
            });
          }
          $('body').css({ 'background-color': 'transparent', 'background-image': 'none' });
          localStorage.setItem('clockBgType', 'youtube');
          localStorage.setItem('clockBgValue', url);
        }
      }

      // --- NEW: Function to handle player state once it's ready ---
      function onPlayerReady(event) {
        const isMuted = $('#youtubeAudioToggle').is(':checked');
        if (isMuted) {
          event.target.mute();
        } else {
          event.target.unMute();
        }
        event.target.playVideo();
      }
      
      function updateFontStyles() {
        const clockWeight = $('#clockWeightSlider').val() || '400';
        const dateWeight = $('#dateWeightSlider').val() || '300';

        let styleTag = $('#font-style-overrides');
        if (!styleTag.length) {
            styleTag = $('<style id="font-style-overrides"></style>').appendTo('head');
        }

        styleTag.text(`
            .flip-clock-wrapper .inn, .flip-clock-meridium a {
                font-weight: ${clockWeight} !important;
            }
            #date-container {
                font-family: 'Roboto', sans-serif !important;
                font-weight: ${dateWeight} !important;
            }
        `);
      }
      
      function loadSettings() {
        const savedZoom = localStorage.getItem('clockZoom');
        if (savedZoom) {
            $('.clock-container').css('zoom', savedZoom);
            $('#sizeSlider').val(savedZoom);
        }

        const savedDarken = localStorage.getItem('clockDarken');
        if (savedDarken) {
            $('#gradient-overlay').css('opacity', savedDarken);
            $('#intensitySlider').val(savedDarken);
        }

        const savedIs24Hour = localStorage.getItem('clockIs24Hour');
        if (savedIs24Hour !== null) { 
            is24HourFormat = (savedIs24Hour === 'true');
            $('#formatToggleBtn').text(is24HourFormat ? 'Switch to 12-Hour' : 'Switch to 24-Hour');
        }

        const savedMuteState = localStorage.getItem('youtubeMuted');
        if (savedMuteState !== null) {
            $('#youtubeAudioToggle').prop('checked', savedMuteState === 'true');
        } else {
            $('#youtubeAudioToggle').prop('checked', true); // Default to muted
        }

        const savedBgType = localStorage.getItem('clockBgType');
        const savedBgValue = localStorage.getItem('clockBgValue');
        if (savedBgType && savedBgValue) {
            if (savedBgType === 'color') {
                $('body').css({ 'background-color': savedBgValue, 'background-image': 'none' });
                $('#colorPicker').val(savedBgValue);
            } else if (savedBgType === 'gradient') {
                $('body').css('background-image', savedBgValue);
            } else if (savedBgType === 'image') {
                $('body').css('background-image', `url(${savedBgValue})`);
            } else if (savedBgType === 'youtube') {
                $('#youtubeUrl').val(savedBgValue);
                if (typeof YT !== 'undefined' && YT.Player) {
                    applyYoutubeBackground(savedBgValue);
                } else {
                    window.onYouTubeIframeAPIReady = function() {
                        applyYoutubeBackground(savedBgValue);
                    };
                }
            }
        }
        
        const savedClockWeight = localStorage.getItem('clockFontWeight');
        if (savedClockWeight) {
            $('#clockWeightSlider').val(savedClockWeight);
        }
        const savedDateWeight = localStorage.getItem('dateFontWeight');
        if (savedDateWeight) {
            $('#dateWeightSlider').val(savedDateWeight);
        }

        updateFontStyles();
      }

      loadSettings(); 

      function initializeClock() {
        if (clock) {
            $('.clock').empty();
        }
        clock = $('.clock').FlipClock({
            clockFace: is24HourFormat ? 'TwentyFourHourClock' : 'TwelveHourClock'
        });
      }
      
      initializeClock();
      
      function updateDate() {
        const now = new Date();
        const day = now.toLocaleString('en-US', { weekday: 'long' });
        const dayOfMonth = now.getDate();
        const month = now.toLocaleString('en-US', { month: 'long' });
        const year = now.getFullYear();
        const fullDate = `${day}, ${dayOfMonth} ${month} ${year}`;
        $('#date-container').text(fullDate);
      }
      updateDate();
      
      $(document).on('visibilitychange', function() {
        if (!document.hidden) {
          initializeClock();
        }
      });
      
      $('#customizeBtn').on('click', function() {
        $('#customizePanel').slideToggle();
      });

      $(document).on('click', function(event) {
        if ($('#customizePanel').is(':visible') && 
            !$(event.target).closest('#customizePanel').length && 
            !$(event.target).closest('#customizeBtn').length) {
          $('#customizePanel').slideUp();
        }
      });

      function updateFullscreenIcons() {
        const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;
        if (isFullscreen) {
            $('#fullscreenBtn .fullscreen-enter-icon').hide();
            $('#fullscreenBtn .fullscreen-exit-icon').show();
        } else {
            $('#fullscreenBtn .fullscreen-enter-icon').show();
            $('#fullscreenBtn .fullscreen-exit-icon').hide();
        }
      }

      $('#fullscreenBtn').on('click', function() {
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
          } else if (document.documentElement.webkitRequestFullscreen) { // Safari
            document.documentElement.webkitRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) { // Safari
            document.webkitExitFullscreen();
          }
        }
        setTimeout(updateFullscreenIcons, 100);
      });

      $(document).on('fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange', function() {
        updateFullscreenIcons();
      });

      function clearVideoBackground() {
          if (ytPlayer && typeof ytPlayer.destroy === 'function') {
            ytPlayer.destroy();
            ytPlayer = null;
          }
          $('#video-background').html('<div id="youtube-player"></div>');
      }

      $('#colorPicker').on('input', function() {
        var newColor = $(this).val();
        $('body').css({ 'background-color': newColor, 'background-image': 'none' });
        clearVideoBackground();
        localStorage.setItem('clockBgType', 'color');
        localStorage.setItem('clockBgValue', newColor);
      });

      $('#imageUpload').on('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) { 
            const imageDataUrl = e.target.result;
            $('body').css('background-image', 'url(' + imageDataUrl + ')'); 
            clearVideoBackground();
            localStorage.setItem('clockBgType', 'image');
            localStorage.setItem('clockBgValue', imageDataUrl);
          };
          reader.readAsDataURL(file);
        }
      });

      $('#applyYoutubeUrl').on('click', function() {
        const url = $('#youtubeUrl').val();
        if (typeof YT !== 'undefined' && YT.Player) {
            applyYoutubeBackground(url);
        } else {
            window.onYouTubeIframeAPIReady = function() {
                applyYoutubeBackground(url);
            };
        }
      });

      // --- NEW: Event listener for the audio toggle ---
      $('#youtubeAudioToggle').on('change', function() {
        const isMuted = $(this).is(':checked');
        if (ytPlayer && typeof ytPlayer.mute === 'function') {
            if (isMuted) {
                ytPlayer.mute();
            } else {
                ytPlayer.unMute();
            }
        }
        localStorage.setItem('youtubeMuted', isMuted);
      });

      $('#sizeSlider').on('input', function() {
        var newSize = $(this).val();
        $('.clock-container').css('zoom', newSize);
        localStorage.setItem('clockZoom', newSize);
      });

      $('#intensitySlider').on('input', function() {
        var newOpacity = $(this).val();
        $('#gradient-overlay').css('opacity', newOpacity);
        localStorage.setItem('clockDarken', newOpacity);
      });
      
      $('#formatToggleBtn').on('click', function() {
        is24HourFormat = !is24HourFormat;
        initializeClock();
        $(this).text(is24HourFormat ? 'Switch to 12-Hour' : 'Switch to 24-Hour');
        localStorage.setItem('clockIs24Hour', is24HourFormat);
      });

      $('.gradient-swatch').on('click', function() {
        var gradient = $(this).data('gradient');
        $('body').css('background-image', gradient);
        clearVideoBackground();
        localStorage.setItem('clockBgType', 'gradient');
        localStorage.setItem('clockBgValue', gradient);
      });

      $('#clockWeightSlider').on('input', function() {
        updateFontStyles();
        localStorage.setItem('clockFontWeight', $(this).val());
      });

      $('#dateWeightSlider').on('input', function() {
        updateFontStyles();
        localStorage.setItem('dateFontWeight', $(this).val());
      });

      $('#resetBtn').on('click', function() {
        $('#sizeSlider').val('2');
        $('#colorPicker').val('#2c2c2c');
        $('#intensitySlider').val('0');
        $('#clockWeightSlider').val('400');
        $('#dateWeightSlider').val('300');
        $('#youtubeUrl').val('');
        
        clearVideoBackground();
        $('body').css({ 'background-color': '#2c2c2c', 'background-image': 'none' });
        $('.clock-container').css('zoom', '2');
        $('#gradient-overlay').css('opacity', '0');
        updateFontStyles(); 

        localStorage.removeItem('clockZoom');
        localStorage.removeItem('clockDarken');
        localStorage.removeItem('clockIs24Hour');
        localStorage.removeItem('clockBgType');
        localStorage.removeItem('clockBgValue');
        localStorage.removeItem('clockFontWeight');
        localStorage.removeItem('dateFontWeight');
        localStorage.removeItem('youtubeMuted');
      });
    });
  </script>

</body>
</html>

